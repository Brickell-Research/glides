name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g., v1.0.0)"
        required: true
        type: string

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref }}

      - name: Setup BEAM (Erlang + Gleam)
        uses: erlef/setup-beam@v1
        with:
          otp-version: "27"
          gleam-version: "1.13.0"
          rebar3-version: "3.25.0"

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: "2.5.6"

      - name: Cache Gleam dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/gleam
            build
          key: ${{ runner.os }}-gleam-release-${{ hashFiles('manifest.toml') }}
          restore-keys: |
            ${{ runner.os }}-gleam-release-
            ${{ runner.os }}-gleam-

      - name: Download dependencies
        run: gleam deps download

      - name: Build Gleam to JavaScript
        run: gleam build --target javascript

      - name: Extract version from gleam.toml
        id: version
        run: |
          VERSION=$(grep '^version' gleam.toml | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Compile binaries for all platforms
        run: |
          mkdir -p dist
          VERSION=${{ steps.version.outputs.version }}
          DIST_DIR="$(pwd)/dist"

          echo "Deno version: $(deno --version)"
          echo "Output directory: $DIST_DIR"

          # Linux x64
          echo "Building Linux x64..."
          deno compile --no-check --allow-read --allow-write \
            --target x86_64-unknown-linux-gnu \
            --output "$DIST_DIR/glides-${VERSION}-linux-x64" main.mjs

          # Linux ARM64
          echo "Building Linux ARM64..."
          deno compile --no-check --allow-read --allow-write \
            --target aarch64-unknown-linux-gnu \
            --output "$DIST_DIR/glides-${VERSION}-linux-arm64" main.mjs

          # macOS x64
          echo "Building macOS x64..."
          deno compile --no-check --allow-read --allow-write \
            --target x86_64-apple-darwin \
            --output "$DIST_DIR/glides-${VERSION}-macos-x64" main.mjs

          # macOS ARM64 (Apple Silicon)
          echo "Building macOS ARM64..."
          deno compile --no-check --allow-read --allow-write \
            --target aarch64-apple-darwin \
            --output "$DIST_DIR/glides-${VERSION}-macos-arm64" main.mjs

          # Windows x64
          echo "Building Windows x64..."
          deno compile --no-check --allow-read --allow-write \
            --target x86_64-pc-windows-msvc \
            --output "$DIST_DIR/glides-${VERSION}-windows-x64.exe" main.mjs

          echo "All binaries built successfully"
          ls -la dist/

      - name: Create archives
        run: |
          cd dist
          VERSION=${{ steps.version.outputs.version }}

          # Linux archives
          tar -czvf glides-${VERSION}-linux-x64.tar.gz glides-${VERSION}-linux-x64
          tar -czvf glides-${VERSION}-linux-arm64.tar.gz glides-${VERSION}-linux-arm64

          # macOS archives
          tar -czvf glides-${VERSION}-macos-x64.tar.gz glides-${VERSION}-macos-x64
          tar -czvf glides-${VERSION}-macos-arm64.tar.gz glides-${VERSION}-macos-arm64

          # Windows archive
          zip glides-${VERSION}-windows-x64.zip glides-${VERSION}-windows-x64.exe

      - name: Generate SHA256 checksums
        run: |
          cd dist
          VERSION=${{ steps.version.outputs.version }}

          sha256sum \
            glides-${VERSION}-linux-x64.tar.gz \
            glides-${VERSION}-linux-arm64.tar.gz \
            glides-${VERSION}-macos-x64.tar.gz \
            glides-${VERSION}-macos-arm64.tar.gz \
            glides-${VERSION}-windows-x64.zip \
            > glides-${VERSION}-checksums.sha256

          echo "Generated checksums:"
          cat glides-${VERSION}-checksums.sha256

      - name: Check if release exists
        id: check_release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ inputs.tag || github.ref_name }}"
          if gh release view "$TAG" &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release $TAG already exists - skipping"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Release $TAG does not exist - will create"
          fi

      - name: Create Release
        if: steps.check_release.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag || github.ref_name }}
          generate_release_notes: true
          files: |
            dist/glides-${{ steps.version.outputs.version }}-linux-x64.tar.gz
            dist/glides-${{ steps.version.outputs.version }}-linux-arm64.tar.gz
            dist/glides-${{ steps.version.outputs.version }}-macos-x64.tar.gz
            dist/glides-${{ steps.version.outputs.version }}-macos-arm64.tar.gz
            dist/glides-${{ steps.version.outputs.version }}-windows-x64.zip
            dist/glides-${{ steps.version.outputs.version }}-checksums.sha256

      - name: Update Homebrew formula
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Calculate SHA256 for each platform from the archives we just created
          SHA_MACOS_X64=$(sha256sum dist/glides-${VERSION}-macos-x64.tar.gz | cut -d' ' -f1)
          SHA_MACOS_ARM64=$(sha256sum dist/glides-${VERSION}-macos-arm64.tar.gz | cut -d' ' -f1)
          SHA_LINUX_X64=$(sha256sum dist/glides-${VERSION}-linux-x64.tar.gz | cut -d' ' -f1)

          echo "SHA256 checksums:"
          echo "  macos-x64:   $SHA_MACOS_X64"
          echo "  macos-arm64: $SHA_MACOS_ARM64"
          echo "  linux-x64:   $SHA_LINUX_X64"

          # Clone the tap repository
          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/Brickell-Research/homebrew-glides.git tap
          cd tap

          # Create Formula directory if it doesn't exist
          mkdir -p Formula

          # Generate the formula file
          cat > Formula/glides.rb << FORMULA_END
          class Glides < Formula
            desc "Djot to HTML slideshow generator"
            homepage "https://github.com/Brickell-Research/glides"
            license "MIT"
            version "${VERSION}"

            # Platform-specific downloads
            if OS.mac? && Hardware::CPU.intel?
              url "https://github.com/Brickell-Research/glides/releases/download/v${VERSION}/glides-${VERSION}-macos-x64.tar.gz"
              sha256 "${SHA_MACOS_X64}"
            elsif OS.mac? && Hardware::CPU.arm?
              url "https://github.com/Brickell-Research/glides/releases/download/v${VERSION}/glides-${VERSION}-macos-arm64.tar.gz"
              sha256 "${SHA_MACOS_ARM64}"
            elsif OS.linux? && Hardware::CPU.intel?
              url "https://github.com/Brickell-Research/glides/releases/download/v${VERSION}/glides-${VERSION}-linux-x64.tar.gz"
              sha256 "${SHA_LINUX_X64}"
            end

            def install
              # The binary name includes version and platform, rename to just "glides"
              if OS.mac? && Hardware::CPU.intel?
                bin.install "glides-#{version}-macos-x64" => "glides"
              elsif OS.mac? && Hardware::CPU.arm?
                bin.install "glides-#{version}-macos-arm64" => "glides"
              elsif OS.linux? && Hardware::CPU.intel?
                bin.install "glides-#{version}-linux-x64" => "glides"
              end
            end

            test do
              system "#{bin}/glides", "--version"
            end
          end
          FORMULA_END

          # Fix indentation (remove leading spaces from heredoc)
          sed -i 's/^          //' Formula/glides.rb

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Commit and push (only if there are changes)
          git add Formula/glides.rb
          if git diff --cached --quiet; then
            echo "Homebrew formula already up to date"
          else
            git commit -m "Update glides to ${VERSION}"
            git push origin main
            echo "Homebrew formula updated to version ${VERSION}"
          fi
